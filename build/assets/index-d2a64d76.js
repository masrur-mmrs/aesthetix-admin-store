import{Y as f,Z as v,W as _,T as p}from"./index-d61dff85.js";import{l as z,g as S,u as M,r as w,i as C,C as I,a as j,b as y,c as L,m as R,e as N,p as F,f as B,P as Q,h as W,j as T,k as G,n as U}from"./a-7777287a.js";import{i as V}from"./is-plan-event-enabled-a83d33b8.js";import"./layout-46e8c2aa.js";import"./index-9b406524.js";import"./index-784107ff.js";import"./index-aa73cc34.js";import"./index-6eb82494.js";function k(e){return e.toLowerCase().replace(".","").replace(/\s+/g,"-")}function D(e,t){return t===void 0&&(t=!1),t?btoa(e).replace(/=/g,""):void 0}function Y(e){return("Integration"in e?e.Integration:e).prototype.name}function Z(e,t,n){var i,a;try{var r=((a=(i=window==null?void 0:window.performance)===null||i===void 0?void 0:i.getEntriesByName(e,"resource"))!==null&&a!==void 0?a:[])[0];r&&t.stats.gauge("legacy_destination_time",Math.round(r.duration),_([n],r.duration<100?["cached"]:[],!0))}catch{}}function H(e,t,n){var i;if("Integration"in e){var a={user:function(){return n.user()},addIntegration:function(){}};e(a),i=e.Integration}else i=e;var r=new i(t);return r.analytics=n,r}function J(e,t,n,i){return f(this,void 0,void 0,function(){var a,r,o,u,s,d;return v(this,function(c){switch(c.label){case 0:a=k(t),r=D(a,i),o=S(),u="".concat(o,"/integrations/").concat(r??a,"/").concat(n,"/").concat(r??a,".dynamic.js.gz"),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,z(u)];case 2:return c.sent(),Z(u,e,t),[3,4];case 3:throw s=c.sent(),e.stats.gauge("legacy_destination_time",-1,["plugin:".concat(t),"failed"]),s;case 4:return d=window["".concat(a,"Deps")],[4,Promise.all(d.map(function(g){return z(o+g+".gz")}))];case 5:return c.sent(),window["".concat(a,"Loader")](),[2,window["".concat(a,"Integration")]]}})})}function K(e,t,n){return f(this,void 0,void 0,function(){var i,a,r,o;return v(this,function(u){return i=S(),a=k(e),r=D(e,n),o="".concat(i,"/integrations/").concat(r??a,"/").concat(t,"/").concat(r??a,".dynamic.js.gz"),[2,M(o)]})})}function X(e){var t,n,i,a;return(a=(n=(t=e==null?void 0:e.versionSettings)===null||t===void 0?void 0:t.override)!==null&&n!==void 0?n:(i=e==null?void 0:e.versionSettings)===null||i===void 0?void 0:i.version)!==null&&a!==void 0?a:"latest"}var $=function(e,t){var n,i=t.type,a=t.bundlingStatus,r=t.versionSettings,o=a!=="unbundled"&&(i==="browser"||((n=r==null?void 0:r.componentTypes)===null||n===void 0?void 0:n.includes("browser")));return!e.startsWith("Segment")&&e!=="Iterable"&&o},q=function(e,t){var n=t.All===!1&&t[e]===void 0;return t[e]===!1||n};function x(e,t){return f(this,void 0,void 0,function(){var n,i=this;return v(this,function(a){switch(a.label){case 0:return n=[],C()?[2,t]:[4,F(function(){return t.length>0&&G()},function(){return f(i,void 0,void 0,function(){var r,o,u;return v(this,function(s){switch(s.label){case 0:return r=t.pop(),r?[4,T(r,e)]:[2];case 1:return o=s.sent(),u=o instanceof U,u||n.push(r),[2]}})})})];case 1:return a.sent(),n.map(function(r){return t.pushWithBackoff(r)}),[2,t]}})})}var tt=function(){function e(t,n,i,a,r,o){a===void 0&&(a={});var u=this;this.options={},this.type="destination",this.middleware=[],this.initializePromise=B(),this.flushing=!1,this.name=t,this.version=n,this.settings=p({},a),this.disableAutoISOConversion=r.disableAutoISOConversion||!1,this.integrationSource=o,this.settings.type&&this.settings.type==="browser"&&delete this.settings.type,this.initializePromise.promise.then(function(s){return u._initialized=s},function(){}),this.options=r,this.buffer=r.disableClientPersistence?new Q(4,[]):new W(4,"".concat(i,":dest-").concat(t)),this.scheduleFlush()}return e.prototype.isLoaded=function(){return!!this._ready},e.prototype.ready=function(){var t=this;return this.initializePromise.promise.then(function(){var n;return(n=t.onReady)!==null&&n!==void 0?n:Promise.resolve()})},e.prototype.load=function(t,n){var i;return f(this,void 0,void 0,function(){var a,r,o=this;return v(this,function(u){switch(u.label){case 0:return this._ready||this.onReady!==void 0?[2]:(i=this.integrationSource)!==null&&i!==void 0?(r=i,[3,3]):[3,1];case 1:return[4,J(t,this.name,this.version,this.options.obfuscate)];case 2:r=u.sent(),u.label=3;case 3:a=r,this.integration=H(a,this.settings,n),this.onReady=new Promise(function(s){var d=function(){o._ready=!0,s(!0)};o.integration.once("ready",d)}),this.integration.on("initialize",function(){o.initializePromise.resolve(!0)});try{w(t,{integrationName:this.name,methodName:"initialize",type:"classic"}),this.integration.initialize()}catch(s){throw w(t,{integrationName:this.name,methodName:"initialize",type:"classic",didError:!0}),this.initializePromise.resolve(!1),s}return[2]}})})},e.prototype.unload=function(t,n){return K(this.name,this.version,this.options.obfuscate)},e.prototype.addMiddleware=function(){for(var t,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];this.middleware=(t=this.middleware).concat.apply(t,n)},e.prototype.shouldBuffer=function(t){return t.event.type!=="page"&&(C()||this._ready===!1||this._initialized===!1)},e.prototype.send=function(t,n,i){var a,r;return f(this,void 0,void 0,function(){var o,u,s,d,c,g;return v(this,function(h){switch(h.label){case 0:if(this.shouldBuffer(t))return this.buffer.push(t),this.scheduleFlush(),[2,t];if(o=(r=(a=this.options)===null||a===void 0?void 0:a.plan)===null||r===void 0?void 0:r.track,u=t.event.event,o&&u&&this.name!=="Segment.io"){if(s=o[u],V(o,s))t.updateEvent("integrations",p(p({},t.event.integrations),s==null?void 0:s.integrations));else return t.updateEvent("integrations",p(p({},t.event.integrations),{All:!1,"Segment.io":!0})),t.cancel(new I({retry:!1,reason:"Event ".concat(u," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"})),[2,t];if(s!=null&&s.enabled&&(s==null?void 0:s.integrations[this.name])===!1)return t.cancel(new I({retry:!1,reason:"Event ".concat(u," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"})),[2,t]}return[4,j(this.name,t.event,this.middleware)];case 1:if(d=h.sent(),d===null)return[2,t];c=new n(d,{traverse:!this.disableAutoISOConversion}),w(t,{integrationName:this.name,methodName:i,type:"classic"}),h.label=2;case 2:return h.trys.push([2,5,,6]),this.integration?[4,this.integration.invoke.call(this.integration,i,c)]:[3,4];case 3:h.sent(),h.label=4;case 4:return[3,6];case 5:throw g=h.sent(),w(t,{integrationName:this.name,methodName:i,type:"classic",didError:!0}),g;case 6:return[2,t]}})})},e.prototype.track=function(t){return f(this,void 0,void 0,function(){return v(this,function(n){return[2,this.send(t,y.Track,"track")]})})},e.prototype.page=function(t){var n;return f(this,void 0,void 0,function(){return v(this,function(i){switch(i.label){case 0:return!((n=this.integration)===null||n===void 0)&&n._assumesPageview&&!this._initialized&&this.integration.initialize(),[4,this.initializePromise.promise];case 1:return i.sent(),[2,this.send(t,y.Page,"page")]}})})},e.prototype.identify=function(t){return f(this,void 0,void 0,function(){return v(this,function(n){return[2,this.send(t,y.Identify,"identify")]})})},e.prototype.alias=function(t){return f(this,void 0,void 0,function(){return v(this,function(n){return[2,this.send(t,y.Alias,"alias")]})})},e.prototype.group=function(t){return f(this,void 0,void 0,function(){return v(this,function(n){return[2,this.send(t,y.Group,"group")]})})},e.prototype.scheduleFlush=function(){var t=this;this.flushing||setTimeout(function(){return f(t,void 0,void 0,function(){var n;return v(this,function(i){switch(i.label){case 0:return this.flushing=!0,n=this,[4,x(this,this.buffer)];case 1:return n.buffer=i.sent(),this.flushing=!1,this.buffer.todo>0&&this.scheduleFlush(),[2]}})})},Math.random()*5e3)},e}();function lt(e,t,n,i,a,r){var o,u;if(n===void 0&&(n={}),i===void 0&&(i={}),L())return[];t.plan&&(i=i??{},i.plan=t.plan);var s=(u=(o=t.middlewareSettings)===null||o===void 0?void 0:o.routingRules)!==null&&u!==void 0?u:[],d=t.integrations,c=i.integrations,g=R(t,i??{}),h=r==null?void 0:r.reduce(function(l,b){var m;return p(p({},l),(m={},m[Y(b)]=b,m))},{}),E=new Set(_(_([],Object.keys(d).filter(function(l){return $(l,d[l])}),!0),Object.keys(h||{}).filter(function(l){return N(d[l])||N(c==null?void 0:c[l])}),!0));return Array.from(E).filter(function(l){return!q(l,n)}).map(function(l){var b=d[l],m=X(b),P=new tt(l,m,e,g[l],i,h==null?void 0:h[l]),O=s.filter(function(A){return A.destinationName===l});return O.length>0&&a&&P.addMiddleware(a),P})}export{tt as LegacyDestination,lt as ajsDestinations};
